user  nginx;
worker_processes  auto;

events {
  worker_connections  1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  tcp_nopush    on;
  tcp_nodelay   on;
  keepalive_timeout  65;
  types_hash_max_size 4096;

  # Cloud Run expects the app to listen on $PORT; we bind Nginx to 8080
  server {
    # Listen on 8080 inside the container (Cloud Run / our Dockerfile expects this)
    listen 8080;
    server_name _;

  # Serve the Angular build which is located in the `browser` folder inside the image
  # (the production build places the app under /usr/share/nginx/html/browser).
  root /usr/share/nginx/html/browser;

    # Redirect the bare root to the dashboard route so visiting '/' lands on '/dashboard'
    # This performs a simple 302 redirect and lets the SPA load the dashboard route.
    location = / {
      return 302 /dashboard;
    }

    # Cache-busting for fingerprinted assets
    location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|ico|woff2?|ttf|eot)$ {
      expires 30d;
      access_log off;
      add_header Cache-Control "public, max-age=2592000, immutable";
      try_files $uri =404;
    }

    # SPA fallback
    location / {
      try_files $uri $uri/ /index.html;
    }

    # Basic healthcheck endpoint (optional)
    location = /healthz {
      access_log off;
      return 200 "ok";
      add_header Content-Type text/plain;
    }
  }
}
